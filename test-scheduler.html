<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🧪 测试Auto Digest调度器</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f8f9fa;
        }
        .test-panel {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .warning { background: #fff3cd; color: #856404; }
        .info { background: #cce7ff; color: #004085; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        button:hover { background: #0056b3; }
        button:disabled { background: #6c757d; cursor: not-allowed; }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .form-group {
            margin: 15px 0;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .form-group input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .highlight {
            background: #ffffcc;
            padding: 2px 4px;
            border-radius: 2px;
        }
    </style>
</head>
<body>
    <h1>🧪 Auto Digest调度器测试工具</h1>
    <p>测试你的Edge Function是否能正常工作</p>

    <!-- 配置 -->
    <div class="test-panel">
        <h3>⚙️ 配置</h3>
        <div class="form-group">
            <label>Supabase URL:</label>
            <input type="text" id="supabaseUrl" value="https://ryncyvnezqwqqtfsweti.supabase.co">
        </div>
        <div class="form-group">
            <label>Service Role Key:</label>
            <input type="password" id="serviceKey" placeholder="用于调用Edge Function">
        </div>
    </div>

    <!-- 快速测试 -->
    <div class="test-panel">
        <h3>⚡ 快速测试</h3>
        <p>立即测试你的调度器是否工作</p>
        <button onclick="testSchedulerNow()">🚀 测试调度器现在</button>
        <button onclick="forceRunDigest()">💪 强制运行Digest (忽略时间)</button>
        <div id="quickStatus" class="status" style="display: none;"></div>
        <div id="quickLog" class="log" style="display: none;"></div>
    </div>

    <!-- 检查用户状态 -->
    <div class="test-panel">
        <h3>👤 检查用户状态</h3>
        <p>查看哪些用户符合auto digest条件</p>
        <button onclick="checkEligibleUsers()">📊 查看符合条件的用户</button>
        <button onclick="checkCurrentTime()">🕒 查看当前UTC时间</button>
        <div id="userStatus" class="status" style="display: none;"></div>
        <div id="userLog" class="log" style="display: none;"></div>
    </div>

    <!-- 设置外部调度 -->
    <div class="test-panel">
        <h3>🌐 设置自动调度</h3>
        <p>获取设置外部Cron服务的信息</p>
        <button onclick="generateCronInfo()">📋 生成Cron Job配置</button>
        <div id="cronStatus" class="status" style="display: none;"></div>
        <div id="cronLog" class="log" style="display: none;"></div>
    </div>

    <script>
        function showStatus(elementId, type, message) {
            const element = document.getElementById(elementId);
            element.className = `status ${type}`;
            element.textContent = message;
            element.style.display = 'block';
        }

        function addLog(elementId, message) {
            const element = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            element.textContent += `[${timestamp}] ${message}\n`;
            element.style.display = 'block';
            element.scrollTop = element.scrollHeight;
        }

        function clearLog(elementId) {
            document.getElementById(elementId).textContent = '';
        }

        // 测试调度器
        window.testSchedulerNow = async function() {
            clearLog('quickLog');
            try {
                const url = document.getElementById('supabaseUrl').value;
                const serviceKey = document.getElementById('serviceKey').value;

                if (!serviceKey) {
                    throw new Error('请填写Service Role Key');
                }

                addLog('quickLog', '调用auto-digest-scheduler Edge Function...');
                addLog('quickLog', `URL: ${url}/functions/v1/auto-digest-scheduler`);

                const response = await fetch(`${url}/functions/v1/auto-digest-scheduler`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${serviceKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        test: true,
                        source: 'manual-test'
                    })
                });

                addLog('quickLog', `响应状态: ${response.status} ${response.statusText}`);

                if (!response.ok) {
                    const errorText = await response.text();
                    addLog('quickLog', `错误响应: ${errorText}`);
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }

                const result = await response.json();
                addLog('quickLog', `成功响应: ${JSON.stringify(result, null, 2)}`);

                if (result.success) {
                    showStatus('quickStatus', 'success', '🎉 调度器测试成功!');
                    addLog('quickLog', `符合条件用户: ${result.eligible_users || 0}`);
                    addLog('quickLog', `处理用户: ${result.processed_users || 0}`);
                } else {
                    showStatus('quickStatus', 'warning', '⚠️ 调度器运行但有问题');
                }

            } catch (error) {
                showStatus('quickStatus', 'error', `❌ 调度器测试失败: ${error.message}`);
                addLog('quickLog', `错误: ${error.message}`);
            }
        };

        // 强制运行
        window.forceRunDigest = async function() {
            addLog('quickLog', '\n--- 强制运行模式 ---');
            try {
                const url = document.getElementById('supabaseUrl').value;
                const serviceKey = document.getElementById('serviceKey').value;

                addLog('quickLog', '强制运行auto digest (忽略时间条件)...');

                const response = await fetch(`${url}/functions/v1/auto-digest-scheduler`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${serviceKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        force: true,
                        ignoreTime: true,
                        source: 'manual-force'
                    })
                });

                const result = await response.json();
                addLog('quickLog', `强制运行结果: ${JSON.stringify(result, null, 2)}`);

                if (response.ok && result.success) {
                    showStatus('quickStatus', 'success', '💪 强制运行成功!');
                } else {
                    showStatus('quickStatus', 'warning', '⚠️ 强制运行有问题');
                }

            } catch (error) {
                addLog('quickLog', `强制运行错误: ${error.message}`);
            }
        };

        // 检查符合条件的用户
        window.checkEligibleUsers = async function() {
            clearLog('userLog');
            try {
                const url = document.getElementById('supabaseUrl').value;
                const serviceKey = document.getElementById('serviceKey').value;

                addLog('userLog', '查询符合auto digest条件的用户...');

                // 查询数据库
                const query = `
                    WITH current_time AS (
                        SELECT 
                            EXTRACT(HOUR FROM NOW() AT TIME ZONE 'UTC') as hour,
                            EXTRACT(MINUTE FROM NOW() AT TIME ZONE 'UTC') as minute
                    )
                    SELECT 
                        u.id,
                        u.email,
                        u.auto_digest_enabled,
                        u.auto_digest_time,
                        EXTRACT(HOUR FROM u.auto_digest_time) as setting_hour,
                        EXTRACT(MINUTE FROM u.auto_digest_time) as setting_minute,
                        u.last_auto_digest_run,
                        CASE 
                            WHEN u.last_auto_digest_run::date = CURRENT_DATE THEN true
                            ELSE false
                        END as ran_today,
                        ABS(EXTRACT(MINUTE FROM u.auto_digest_time) - ct.minute) as minute_diff
                    FROM users u, current_time ct
                    WHERE u.auto_digest_enabled = true
                    ORDER BY minute_diff
                `;

                const response = await fetch(`${url}/rest/v1/rpc/query_users_auto_digest`, {
                    method: 'POST',
                    headers: {
                        'apikey': serviceKey,
                        'Authorization': `Bearer ${serviceKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ query })
                });

                if (!response.ok) {
                    // 尝试直接查询users表
                    const usersResponse = await fetch(`${url}/rest/v1/users?select=id,email,auto_digest_enabled,auto_digest_time,last_auto_digest_run&auto_digest_enabled=eq.true`, {
                        headers: {
                            'apikey': serviceKey,
                            'Authorization': `Bearer ${serviceKey}`
                        }
                    });

                    if (usersResponse.ok) {
                        const users = await usersResponse.json();
                        const now = new Date();
                        const currentHour = now.getUTCHours();
                        const currentMinute = now.getUTCMinutes();

                        addLog('userLog', `当前UTC时间: ${currentHour.toString().padStart(2, '0')}:${currentMinute.toString().padStart(2, '0')}`);
                        addLog('userLog', `找到 ${users.length} 个启用auto digest的用户:\n`);

                        users.forEach((user, index) => {
                            const timeStr = user.auto_digest_time || '09:00:00';
                            const [hour, minute] = timeStr.split(':').map(Number);
                            const timeDiff = Math.abs(minute - currentMinute);
                            const hourMatch = hour === currentHour;
                            const withinWindow = timeDiff <= 2;
                            const ranToday = user.last_auto_digest_run && 
                                new Date(user.last_auto_digest_run).toDateString() === new Date().toDateString();

                            addLog('userLog', `用户 ${index + 1}: ${user.email || user.id}`);
                            addLog('userLog', `  设置时间: ${timeStr}`);
                            addLog('userLog', `  时间匹配: ${hourMatch ? '✅' : '❌'} 小时, ${withinWindow ? '✅' : '❌'} 分钟窗口`);
                            addLog('userLog', `  今日已运行: ${ranToday ? '✅' : '❌'}`);
                            addLog('userLog', `  符合条件: ${hourMatch && withinWindow && !ranToday ? '🎯 是' : '❌ 否'}\n`);
                        });

                        showStatus('userStatus', 'success', '✅ 用户状态检查完成');
                    } else {
                        throw new Error('无法查询用户数据');
                    }
                } else {
                    const result = await response.json();
                    addLog('userLog', `查询结果: ${JSON.stringify(result, null, 2)}`);
                }

            } catch (error) {
                showStatus('userStatus', 'error', `❌ 检查失败: ${error.message}`);
                addLog('userLog', `错误: ${error.message}`);
            }
        };

        // 检查当前时间
        window.checkCurrentTime = async function() {
            addLog('userLog', '\n--- 当前时间信息 ---');
            const now = new Date();
            addLog('userLog', `本地时间: ${now.toLocaleString()}`);
            addLog('userLog', `UTC时间: ${now.toISOString()}`);
            addLog('userLog', `UTC小时: ${now.getUTCHours()}`);
            addLog('userLog', `UTC分钟: ${now.getUTCMinutes()}`);
        };

        // 生成Cron配置
        window.generateCronInfo = async function() {
            clearLog('cronLog');
            const url = document.getElementById('supabaseUrl').value;
            const serviceKey = document.getElementById('serviceKey').value;

            if (!serviceKey) {
                showStatus('cronStatus', 'warning', '⚠️ 请先填写Service Role Key');
                return;
            }

            addLog('cronLog', '🌐 外部Cron服务配置信息:\n');
            
            addLog('cronLog', '=== cron-job.org 配置 ===');
            addLog('cronLog', `URL: ${url}/functions/v1/auto-digest-scheduler`);
            addLog('cronLog', 'Method: POST');
            addLog('cronLog', 'Schedule: */5 * * * * (每5分钟)');
            addLog('cronLog', 'Headers:');
            addLog('cronLog', `  Authorization: Bearer ${serviceKey.substring(0, 20)}...`);
            addLog('cronLog', '  Content-Type: application/json');
            addLog('cronLog', 'Body:');
            addLog('cronLog', '  {"source": "cron-job"}\n');

            addLog('cronLog', '=== GitHub Actions 配置 ===');
            addLog('cronLog', '文件路径: .github/workflows/auto-digest.yml');
            addLog('cronLog', '需要设置Secret: SUPABASE_SERVICE_ROLE_KEY\n');

            addLog('cronLog', '=== 测试命令 ===');
            addLog('cronLog', `curl -X POST \\`);
            addLog('cronLog', `  -H "Authorization: Bearer ${serviceKey.substring(0, 20)}..." \\`);
            addLog('cronLog', `  -H "Content-Type: application/json" \\`);
            addLog('cronLog', `  -d '{"test": true}' \\`);
            addLog('cronLog', `  ${url}/functions/v1/auto-digest-scheduler`);

            showStatus('cronStatus', 'info', '📋 配置信息已生成');
        };
    </script>
</body>
</html> 