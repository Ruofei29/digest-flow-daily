<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🔍 调试更新问题 - API成功但数据未更新</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: #f8f9fa;
        }
        .debug-panel {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .success { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        .error { background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        .warning { background: #fff3cd; border: 1px solid #ffeaa7; color: #856404; }
        .info { background: #cce7ff; border: 1px solid #99d3ff; color: #004085; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .form-group {
            margin: 10px 0;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .form-group input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <h1>🔍 调试更新问题</h1>
    <p><strong>问题</strong>: API返回200/204成功，但auto_digest_enabled仍然是false</p>

    <!-- 配置 -->
    <div class="debug-panel">
        <h3>📋 配置</h3>
        <div class="form-group">
            <label>Supabase URL:</label>
            <input type="text" id="supabaseUrl" value="https://ryncyvnezqwqqtfsweti.supabase.co">
        </div>
        <div class="form-group">
            <label>Service Role Key:</label>
            <input type="password" id="serviceKey" placeholder="用于直接更新数据库">
        </div>
        <div class="form-group">
            <label>用户ID:</label>
            <input type="text" id="userId" placeholder="目标用户的ID">
        </div>
    </div>

    <!-- 一键解决 -->
    <div class="debug-panel">
        <h3>⚡ 一键解决</h3>
        <p>直接使用管理员权限强制更新你的设置</p>
        <button onclick="forceUpdateNow()">立即强制更新 auto_digest_enabled = true</button>
        <div id="forceStatus" class="status" style="display: none;"></div>
        <div id="forceLog" class="log" style="display: none;"></div>
    </div>

    <!-- 步骤化调试 -->
    <div class="debug-panel">
        <h3>🔍 详细调试</h3>
        <button onclick="checkCurrentValue()">1. 检查当前值</button>
        <button onclick="testDirectUpdate()">2. 测试直接更新</button>
        <button onclick="verifyUpdate()">3. 验证更新结果</button>
        <div id="debugStatus" class="status" style="display: none;"></div>
        <div id="debugLog" class="log" style="display: none;"></div>
    </div>

    <script>
        function showStatus(elementId, type, message) {
            const element = document.getElementById(elementId);
            element.className = `status ${type}`;
            element.textContent = message;
            element.style.display = 'block';
        }

        function addLog(elementId, message) {
            const element = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            element.textContent += `[${timestamp}] ${message}\n`;
            element.style.display = 'block';
            element.scrollTop = element.scrollHeight;
        }

        function clearLog(elementId) {
            document.getElementById(elementId).textContent = '';
        }

        // 一键强制更新
        window.forceUpdateNow = async function() {
            clearLog('forceLog');
            try {
                const url = document.getElementById('supabaseUrl').value;
                const serviceKey = document.getElementById('serviceKey').value;
                const userId = document.getElementById('userId').value;

                if (!url || !serviceKey) {
                    throw new Error('请填写Supabase URL和Service Role Key');
                }

                if (!userId) {
                    throw new Error('请填写用户ID');
                }

                addLog('forceLog', '开始强制更新...');
                addLog('forceLog', `目标用户ID: ${userId}`);

                // 直接使用REST API更新
                const response = await fetch(`${url}/rest/v1/users?id=eq.${userId}`, {
                    method: 'PATCH',
                    headers: {
                        'apikey': serviceKey,
                        'Authorization': `Bearer ${serviceKey}`,
                        'Content-Type': 'application/json',
                        'Prefer': 'return=representation'
                    },
                    body: JSON.stringify({
                        auto_digest_enabled: true,
                        auto_digest_time: '10:00:00',
                        auto_digest_timezone: 'UTC',
                        updated_at: new Date().toISOString()
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }

                const result = await response.json();
                
                if (result && result.length > 0) {
                    showStatus('forceStatus', 'success', '🎉 强制更新成功!');
                    addLog('forceLog', `更新成功: auto_digest_enabled = ${result[0].auto_digest_enabled}`);
                    addLog('forceLog', `更新时间: ${result[0].auto_digest_time}`);
                    addLog('forceLog', '现在回到你的应用，应该能看到正确的设置了!');
                } else {
                    throw new Error('更新成功但没有返回数据');
                }

            } catch (error) {
                showStatus('forceStatus', 'error', `❌ 强制更新失败: ${error.message}`);
                addLog('forceLog', `错误: ${error.message}`);
            }
        };

        // 检查当前值
        window.checkCurrentValue = async function() {
            clearLog('debugLog');
            try {
                const url = document.getElementById('supabaseUrl').value;
                const serviceKey = document.getElementById('serviceKey').value;
                const userId = document.getElementById('userId').value;

                if (!url || !serviceKey || !userId) {
                    throw new Error('请填写所有必需字段');
                }

                addLog('debugLog', '查询当前用户数据...');

                const response = await fetch(`${url}/rest/v1/users?select=*&id=eq.${userId}`, {
                    headers: {
                        'apikey': serviceKey,
                        'Authorization': `Bearer ${serviceKey}`
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const users = await response.json();
                if (users.length === 0) {
                    throw new Error('未找到用户');
                }

                const user = users[0];
                addLog('debugLog', `当前用户数据:`);
                addLog('debugLog', `  auto_digest_enabled: ${user.auto_digest_enabled}`);
                addLog('debugLog', `  auto_digest_time: ${user.auto_digest_time}`);
                addLog('debugLog', `  auto_digest_timezone: ${user.auto_digest_timezone}`);
                addLog('debugLog', `  updated_at: ${user.updated_at}`);

                if (user.auto_digest_enabled === true) {
                    showStatus('debugStatus', 'success', '✅ 当前值已经是true');
                } else {
                    showStatus('debugStatus', 'warning', '⚠️ 当前值确实是false');
                }

            } catch (error) {
                showStatus('debugStatus', 'error', `❌ 检查失败: ${error.message}`);
                addLog('debugLog', `错误: ${error.message}`);
            }
        };

        // 测试直接更新
        window.testDirectUpdate = async function() {
            addLog('debugLog', '\n--- 测试直接更新 ---');
            try {
                const url = document.getElementById('supabaseUrl').value;
                const serviceKey = document.getElementById('serviceKey').value;
                const userId = document.getElementById('userId').value;

                addLog('debugLog', '执行直接更新...');

                const response = await fetch(`${url}/rest/v1/users?id=eq.${userId}`, {
                    method: 'PATCH',
                    headers: {
                        'apikey': serviceKey,
                        'Authorization': `Bearer ${serviceKey}`,
                        'Content-Type': 'application/json',
                        'Prefer': 'return=representation'
                    },
                    body: JSON.stringify({
                        auto_digest_enabled: true,
                        auto_digest_time: '10:00:00',
                        auto_digest_timezone: 'UTC',
                        updated_at: new Date().toISOString()
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    addLog('debugLog', `更新失败: ${errorText}`);
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }

                const result = await response.json();
                addLog('debugLog', `更新响应: ${JSON.stringify(result, null, 2)}`);
                
                showStatus('debugStatus', 'success', '✅ 直接更新成功');

            } catch (error) {
                showStatus('debugStatus', 'error', `❌ 直接更新失败: ${error.message}`);
                addLog('debugLog', `错误: ${error.message}`);
            }
        };

        // 验证更新结果
        window.verifyUpdate = async function() {
            addLog('debugLog', '\n--- 验证更新结果 ---');
            // 重用检查当前值的逻辑
            await checkCurrentValue();
        };
    </script>
</body>
</html> 