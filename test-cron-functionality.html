<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>测试Cron Job功能</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .test-section {
            margin-bottom: 30px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        
        button:hover {
            background-color: #0056b3;
        }
        
        .success {
            color: #28a745;
            background-color: #d4edda;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        
        .error {
            color: #dc3545;
            background-color: #f8d7da;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        
        .info {
            color: #17a2b8;
            background-color: #d1ecf1;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        
        pre {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
            white-space: pre-wrap;
        }
        
        input[type="text"] {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-success { background-color: #28a745; }
        .status-error { background-color: #dc3545; }
        .status-pending { background-color: #ffc107; }
    </style>
</head>
<body>
    <div class="container">
        <h1>🕒 Cron Job功能测试</h1>
        <p>这个工具帮助你测试每5分钟的cron任务是否能成功触发auto-digest-scheduler</p>
    </div>

    <div class="container">
        <div class="test-section">
            <h2>📋 配置信息</h2>
            <label for="serviceKey">Service Role Key:</label>
            <input type="text" id="serviceKey" placeholder="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..." />
            
            <div class="info">
                <strong>当前Cron配置:</strong><br>
                - 频率: */5 * * * * (每5分钟)<br>
                - URL: https://ryncyvnezqwqqtfsweti.supabase.co/functions/v1/auto-digest-scheduler<br>
                - 时间窗口: 5分钟容差
            </div>
        </div>

        <div class="test-section">
            <h2>🧪 功能测试</h2>
            
            <button onclick="testSchedulerDirect()">1. 直接测试Scheduler函数</button>
            <button onclick="checkUserSettings()">2. 检查用户设置</button>
            <button onclick="simulateCronCall()">3. 模拟Cron调用</button>
            <button onclick="checkRecentLogs()">4. 查看近期执行日志</button>
            
            <div id="testResults"></div>
        </div>

        <div class="test-section">
            <h2>⏰ 时间分析</h2>
            <button onclick="analyzeTimingSetup()">分析时间设置</button>
            <div id="timingAnalysis"></div>
        </div>

        <div class="test-section">
            <h2>🔧 问题诊断</h2>
            <button onclick="runDiagnostics()">运行完整诊断</button>
            <div id="diagnosticsResults"></div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://ryncyvnezqwqqtfsweti.supabase.co';
        
        function getServiceKey() {
            const key = document.getElementById('serviceKey').value.trim();
            if (!key) {
                showError('请输入Service Role Key');
                return null;
            }
            return key;
        }
        
        function showResult(message, type = 'info') {
            const div = document.getElementById('testResults');
            const className = type === 'success' ? 'success' : type === 'error' ? 'error' : 'info';
            div.innerHTML += `<div class="${className}">${message}</div>`;
        }
        
        function showError(message) {
            showResult(`❌ ${message}`, 'error');
        }
        
        function showSuccess(message) {
            showResult(`✅ ${message}`, 'success');
        }
        
        function showInfo(message) {
            showResult(`ℹ️ ${message}`, 'info');
        }
        
        async function testSchedulerDirect() {
            const serviceKey = getServiceKey();
            if (!serviceKey) return;
            
            document.getElementById('testResults').innerHTML = '';
            showInfo('正在直接测试auto-digest-scheduler函数...');
            
            try {
                const response = await fetch(`${SUPABASE_URL}/functions/v1/auto-digest-scheduler`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${serviceKey}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ test: true, source: 'manual-test' })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showSuccess('Scheduler函数调用成功!');
                    showResult(`<pre>${JSON.stringify(result, null, 2)}</pre>`);
                    
                    if (result.stats) {
                        showInfo(`处理统计: 成功 ${result.stats.success}, 失败 ${result.stats.failed}, 跳过 ${result.stats.skipped}`);
                    }
                } else {
                    showError(`函数调用失败: ${response.status} ${response.statusText}`);
                    showResult(`<pre>${JSON.stringify(result, null, 2)}</pre>`);
                }
            } catch (error) {
                showError(`请求失败: ${error.message}`);
            }
        }
        
        async function checkUserSettings() {
            const serviceKey = getServiceKey();
            if (!serviceKey) return;
            
            showInfo('正在检查用户auto digest设置...');
            
            try {
                // 使用service role key查询用户设置
                const response = await fetch(`${SUPABASE_URL}/rest/v1/users?auto_digest_enabled=eq.true&select=id,email,auto_digest_enabled,auto_digest_time,auto_digest_timezone,last_auto_digest_run`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${serviceKey}`,
                        'Content-Type': 'application/json',
                        'apikey': serviceKey
                    }
                });
                
                const users = await response.json();
                
                if (response.ok) {
                    showSuccess(`找到 ${users.length} 个启用了auto digest的用户`);
                    
                    if (users.length > 0) {
                        users.forEach((user, index) => {
                            const lastRun = user.last_auto_digest_run ? new Date(user.last_auto_digest_run).toLocaleString() : '从未执行';
                            showResult(`
                                <strong>用户 ${index + 1}:</strong><br>
                                - Email: ${user.email}<br>
                                - 执行时间: ${user.auto_digest_time}<br>
                                - 时区: ${user.auto_digest_timezone}<br>
                                - 上次执行: ${lastRun}
                            `);
                        });
                    } else {
                        showInfo('没有用户启用了auto digest功能');
                    }
                } else {
                    showError(`查询失败: ${response.status}`);
                }
            } catch (error) {
                showError(`查询用户设置失败: ${error.message}`);
            }
        }
        
        async function simulateCronCall() {
            const serviceKey = getServiceKey();
            if (!serviceKey) return;
            
            showInfo('正在模拟cron任务调用...');
            
            try {
                // 完全模拟你的SQL中的调用
                const response = await fetch(`${SUPABASE_URL}/functions/v1/auto-digest-scheduler`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${serviceKey}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({}) // 空body，模拟cron调用
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showSuccess('Cron调用模拟成功!');
                    showResult(`<pre>${JSON.stringify(result, null, 2)}</pre>`);
                    
                    // 分析结果
                    if (result.success) {
                        if (result.stats && result.stats.total > 0) {
                            showSuccess(`🎯 发现符合条件的用户并已处理!`);
                        } else {
                            showInfo(`⏰ 当前没有用户需要执行digest (可能时间不匹配)`);
                        }
                    }
                } else {
                    showError(`Cron调用失败: ${response.status}`);
                }
            } catch (error) {
                showError(`Cron调用模拟失败: ${error.message}`);
            }
        }
        
        async function analyzeTimingSetup() {
            const serviceKey = getServiceKey();
            if (!serviceKey) return;
            
            const div = document.getElementById('timingAnalysis');
            div.innerHTML = '<div class="info">正在分析时间设置...</div>';
            
            try {
                // 获取当前时间信息
                const now = new Date();
                const utcTime = now.toISOString();
                const localTime = now.toLocaleString();
                
                div.innerHTML = `
                    <div class="info">
                        <h3>⏰ 当前时间分析</h3>
                        <strong>当前UTC时间:</strong> ${utcTime}<br>
                        <strong>当前本地时间:</strong> ${localTime}<br>
                        <strong>Cron执行频率:</strong> 每5分钟 (*/5 * * * *)<br>
                        <strong>时间窗口:</strong> ±5分钟容差<br><br>
                        
                        <h4>🔍 时间匹配逻辑:</h4>
                        1. Cron每5分钟触发一次<br>
                        2. Scheduler检查每个用户的本地时间<br>
                        3. 如果用户本地时间在设置时间±5分钟内，则执行<br>
                        4. 同一天内只执行一次<br><br>
                        
                        <h4>📝 建议:</h4>
                        - 如果用户设置9:00执行，8:55-9:05之间的任何cron触发都会执行<br>
                        - 更频繁的cron (如每分钟) 可以提供更精确的时间控制<br>
                        - 当前5分钟间隔应该足够大多数用例
                    </div>
                `;
                
                // 检查下次cron执行时间
                const nextCron = new Date(Math.ceil(now.getTime() / (5 * 60 * 1000)) * (5 * 60 * 1000));
                div.innerHTML += `
                    <div class="success">
                        <strong>下次Cron执行时间:</strong> ${nextCron.toLocaleString()}<br>
                        <strong>距离下次执行:</strong> ${Math.round((nextCron - now) / 1000)} 秒
                    </div>
                `;
            } catch (error) {
                div.innerHTML = `<div class="error">时间分析失败: ${error.message}</div>`;
            }
        }
        
        async function runDiagnostics() {
            const serviceKey = getServiceKey();
            if (!serviceKey) return;
            
            const div = document.getElementById('diagnosticsResults');
            div.innerHTML = '<div class="info">正在运行完整诊断...</div>';
            
            let diagnostics = [];
            
            // 1. 测试函数可访问性
            try {
                const response = await fetch(`${SUPABASE_URL}/functions/v1/auto-digest-scheduler`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${serviceKey}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ test: true })
                });
                
                if (response.ok) {
                    diagnostics.push({ test: 'Function Accessibility', status: 'success', message: '函数可正常访问' });
                } else {
                    diagnostics.push({ test: 'Function Accessibility', status: 'error', message: `函数访问失败: ${response.status}` });
                }
            } catch (error) {
                diagnostics.push({ test: 'Function Accessibility', status: 'error', message: `网络错误: ${error.message}` });
            }
            
            // 2. 检查认证
            try {
                const testAuth = await fetch(`${SUPABASE_URL}/rest/v1/users?limit=1`, {
                    headers: {
                        'Authorization': `Bearer ${serviceKey}`,
                        'apikey': serviceKey
                    }
                });
                
                if (testAuth.ok) {
                    diagnostics.push({ test: 'Service Key Authentication', status: 'success', message: 'Service Key认证成功' });
                } else {
                    diagnostics.push({ test: 'Service Key Authentication', status: 'error', message: 'Service Key认证失败' });
                }
            } catch (error) {
                diagnostics.push({ test: 'Service Key Authentication', status: 'error', message: `认证测试失败: ${error.message}` });
            }
            
            // 3. 检查数据库schema
            try {
                const schemaCheck = await fetch(`${SUPABASE_URL}/rest/v1/users?select=auto_digest_enabled&limit=1`, {
                    headers: {
                        'Authorization': `Bearer ${serviceKey}`,
                        'apikey': serviceKey
                    }
                });
                
                if (schemaCheck.ok) {
                    diagnostics.push({ test: 'Database Schema', status: 'success', message: 'auto_digest字段存在' });
                } else {
                    diagnostics.push({ test: 'Database Schema', status: 'error', message: 'auto_digest字段可能不存在' });
                }
            } catch (error) {
                diagnostics.push({ test: 'Database Schema', status: 'error', message: `Schema检查失败: ${error.message}` });
            }
            
            // 显示诊断结果
            let html = '<h3>🔧 诊断结果</h3>';
            diagnostics.forEach(d => {
                const statusClass = d.status === 'success' ? 'status-success' : 'status-error';
                html += `
                    <div style="margin: 10px 0; padding: 10px; border-left: 4px solid ${d.status === 'success' ? '#28a745' : '#dc3545'};">
                        <span class="status-indicator ${statusClass}"></span>
                        <strong>${d.test}:</strong> ${d.message}
                    </div>
                `;
            });
            
            // 添加建议
            const successCount = diagnostics.filter(d => d.status === 'success').length;
            if (successCount === diagnostics.length) {
                html += `
                    <div class="success">
                        <h4>✅ 所有检查通过!</h4>
                        你的cron任务应该可以正常工作。如果仍有问题，请检查:
                        <ul>
                            <li>用户是否正确设置了auto digest时间</li>
                            <li>当前时间是否在用户设置的时间窗口内</li>
                            <li>用户今天是否已经执行过digest</li>
                        </ul>
                    </div>
                `;
            } else {
                html += `
                    <div class="error">
                        <h4>❌ 发现问题</h4>
                        请解决上述失败的检查项目，然后重新测试。
                    </div>
                `;
            }
            
            div.innerHTML = html;
        }
        
        // 页面加载时显示当前时间
        function updateCurrentTime() {
            const now = new Date();
            const timeInfo = document.querySelector('.info');
            if (timeInfo) {
                const currentTime = document.createElement('div');
                currentTime.style.marginTop = '10px';
                currentTime.style.fontSize = '0.9em';
                currentTime.innerHTML = `<strong>当前时间:</strong> ${now.toLocaleString()} (${now.toISOString()})`;
                timeInfo.appendChild(currentTime);
            }
        }
        
        // 每秒更新时间显示
        setInterval(() => {
            const timeDisplays = document.querySelectorAll('[data-current-time]');
            const now = new Date();
            timeDisplays.forEach(el => {
                el.textContent = now.toLocaleString();
            });
        }, 1000);
    </script>
</body>
</html>